<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Banco de Boas Práticas - Controle Interno</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #1a5f7a;
        --secondary-color: #159895;
        --accent-color: #57c5b6;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --success-color: #28a745;
        --danger-color: #dc3545;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 2rem 0;
        text-align: center;
        border-bottom: 4px solid var(--accent-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      header p {
        font-size: 1.2rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .main-content {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 30px;
      }

      .form-section {
        flex: 1;
        min-width: 300px;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .form-section h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--accent-color);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--dark-color);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--accent-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(87, 197, 182, 0.2);
      }

      .form-group textarea {
        min-height: 150px;
        resize: vertical;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      button i {
        margin-right: 8px;
      }

      button:hover {
        background-color: var(--secondary-color);
      }

      .practices-section {
        flex: 2;
        min-width: 300px;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .practices-section h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--accent-color);
      }

      .search-box {
        margin-bottom: 20px;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #777;
      }

      .practice-card {
        background-color: var(--light-color);
        border-left: 4px solid var(--accent-color);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        transition: transform 0.3s;
        position: relative;
      }

      .practice-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .practice-card h3 {
        color: var(--primary-color);
        margin-bottom: 10px;
        padding-right: 30px;
      }

      .practice-meta {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .practice-content {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #ddd;
      }

      .stats {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-around;
        text-align: center;
      }

      .stat-item {
        padding: 10px;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
      }

      .stat-label {
        color: #666;
      }

      footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        color: #666;
        border-top: 1px solid #ddd;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background-color: var(--success-color);
        color: white;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 1000;
      }

      .notification.error {
        background-color: var(--danger-color);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--primary-color);
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }

        .stats {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="notification" id="notification">
      <i class="fas fa-check-circle"></i>
      <span id="notification-text">Boa prática enviada com sucesso!</span>
    </div>

    <header>
      <div class="container">
        <h1><i class="fas fa-database"></i> Banco de Boas Práticas</h1>
        <p>
          Compartilhe e consulte experiências para melhorar os processos de
          auditoria
        </p>
      </div>
    </header>

    <div class="container">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="total-practices">0</div>
          <div class="stat-label">Práticas Cadastradas</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="total-users">0</div>
          <div class="stat-label">Auditores Participantes</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="total-managements">0</div>
          <div class="stat-label">Gerências Envolvidas</div>
        </div>
      </div>

      <div class="main-content">
        <section class="form-section">
          <h2>
            <i class="fas fa-share-square"></i> Compartilhe uma Boa Prática
          </h2>
          <form id="practice-form">
            <div class="form-group">
              <label for="name">Seu Nome:</label>
              <input
                type="text"
                id="name"
                required
                placeholder="Digite seu nome completo"
              />
            </div>

            <div class="form-group">
              <label for="management">Gerência de Auditoria:</label>
              <select id="management" required>
                <option value="">Selecione uma gerência</option>
                <option value="GAUD I">GAUD I</option>
                <option value="GAUD II">GAUD II</option>
                <option value="GAUD III">GAUD III</option>
                <option value="GAUD IV">GAUD IV</option>
                <option value="GAUD V">GAUD V</option>
              </select>
            </div>

            <div class="form-group">
              <label for="practice">Boas Práticas:</label>
              <textarea
                id="practice"
                placeholder="Descreva aqui as boas práticas identificadas, soluções implementadas, ou lições aprendidas..."
                required
              ></textarea>
            </div>

            <button type="submit" id="submit-btn">
              <i class="fas fa-paper-plane"></i> Enviar Boa Prática
            </button>
          </form>
        </section>

        <section class="practices-section">
          <h2><i class="fas fa-lightbulb"></i> Boas Práticas Compartilhadas</h2>

          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="search-input"
              placeholder="Buscar boas práticas..."
            />
          </div>

          <div id="practices-list">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Carregando boas práticas...
            </div>
          </div>
        </section>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>
          Banco de Boas Práticas - Secretaria Adjunta de Controle Interno da STC
          &copy; 2025
        </p>
        <p>
          Esta aplicação demonstra como seria a interface para coleta de boas
          práticas. Criada para fins acadêmicos. Atividade extensionista do
          Curso de Análise e Desenvolvimento de Sistemas.
        </p>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const practiceForm = document.getElementById("practice-form");
        const practicesList = document.getElementById("practices-list");
        const searchInput = document.getElementById("search-input");
        const notification = document.getElementById("notification");
        const notificationText = document.getElementById("notification-text");
        const totalPractices = document.getElementById("total-practices");
        const totalUsers = document.getElementById("total-users");
        const totalManagements = document.getElementById("total-managements");
        const submitBtn = document.getElementById("submit-btn");

        // URL da API - ALTERE ESTA URL DEPOIS DO DEPLOY
        const API_URL = "http://localhost:5000/api/practices";

        // Função para formatar a data
        function formatDate(date) {
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        }

        // Função para mostrar notificação
        function showNotification(message, isError = false) {
          notificationText.textContent = message;
          notification.className = isError
            ? "notification error"
            : "notification";
          notification.style.display = "block";
          setTimeout(() => {
            notification.style.display = "none";
          }, 4000);
        }

        // Função para carregar práticas do backend
        async function loadPractices() {
          try {
            practicesList.innerHTML =
              '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando boas práticas...</div>';

            const response = await fetch(API_URL);
            const result = await response.json();

            if (result.success) {
              renderPractices(result.data);
              updateStats(result.data);
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            console.error("Erro ao carregar práticas:", error);
            practicesList.innerHTML =
              '<div class="practice-card"><p>Erro ao carregar práticas. Verifique se o servidor está rodando.</p></div>';
            showNotification("Erro ao carregar práticas", true);
          }
        }

        // Função para buscar práticas
        async function searchPractices(term) {
          try {
            const response = await fetch(
              `${API_URL}/search/${encodeURIComponent(term)}`
            );
            const result = await response.json();

            if (result.success) {
              renderPractices(result.data);
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            console.error("Erro na busca:", error);
            showNotification("Erro na busca", true);
          }
        }

        // Atualizar estatísticas
        function updateStats(practices) {
          totalPractices.textContent = practices.length;

          const uniqueUsers = new Set(practices.map((p) => p.name));
          totalUsers.textContent = uniqueUsers.size;

          const uniqueManagements = new Set(practices.map((p) => p.management));
          totalManagements.textContent = uniqueManagements.size;
        }

        // Função para renderizar as boas práticas
        function renderPractices(practicesArray) {
          practicesList.innerHTML = "";

          if (practicesArray.length === 0) {
            practicesList.innerHTML =
              '<div class="practice-card"><p>Nenhuma boa prática encontrada. Seja o primeiro a compartilhar!</p></div>';
            return;
          }

          practicesArray.forEach((practice) => {
            const practiceElement = document.createElement("div");
            practiceElement.classList.add("practice-card");
            practiceElement.innerHTML = `
                        <h3>${practice.practice.substring(0, 80)}${
              practice.practice.length > 80 ? "..." : ""
            }</h3>
                        <div class="practice-meta">
                            <span><i class="fas fa-user"></i> ${
                              practice.name
                            }</span>
                            <span><i class="fas fa-building"></i> ${
                              practice.management
                            }</span>
                            <span><i class="fas fa-calendar"></i> ${
                              practice.date
                            }</span>
                        </div>
                        <div class="practice-content">
                            <p>${practice.practice}</p>
                        </div>
                    `;
            practicesList.appendChild(practiceElement);
          });
        }

        // Manipular o envio do formulário
        practiceForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const name = document.getElementById("name").value.trim();
          const management = document.getElementById("management").value;
          const practiceText = document.getElementById("practice").value.trim();

          if (!name || !management || !practiceText) {
            showNotification("Preencha todos os campos", true);
            return;
          }

          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Enviando...';
          submitBtn.disabled = true;

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name,
                management,
                practice: practiceText,
                date: formatDate(new Date()),
              }),
            });

            const result = await response.json();

            if (result.success) {
              practiceForm.reset();
              showNotification("Boa prática cadastrada com sucesso!");
              await loadPractices(); // Recarrega a lista
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            console.error("Erro:", error);
            showNotification(
              "Erro ao enviar boa prática: " + error.message,
              true
            );
          } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        });

        // Implementar a funcionalidade de busca
        let searchTimeout;
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.trim();

          clearTimeout(searchTimeout);

          if (searchTerm === "") {
            loadPractices();
            return;
          }

          searchTimeout = setTimeout(() => {
            searchPractices(searchTerm);
          }, 500);
        });

        // Carregar práticas ao inicializar
        loadPractices();
      });
    </script>
  </body>
</html>
